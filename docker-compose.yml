# project_root/docker-compose.yml
version: '3.8'

# ------------------------------------------------------------
# CRITICAL: Load all environment files (committed and secret)
# ------------------------------------------------------------
env_file:
  - ./.env
  - ./.env.secret

# ------------------------------------------------------------
# SERVICES (All definitions in one file)
# ------------------------------------------------------------
services:
  # 1. üóÑÔ∏è Database Service (Shared by Dev and Prod)
  db_main:
    image: ${POSTGRES_IMAGE}
    container_name: ${PROJECT_NAME}_db_main
    environment:
      # Use variables from .env.secret
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      # This is the default DB created on startup; Dev/Prod will create their own.
      POSTGRES_DB: default_db
    ports:
      # Expose DB only for Synology portainer/local access, if needed
      - "5432:${POSTGRES_PORT}"
    volumes:
      # Ensure data persistence on the NAS
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ${VALINOR_NETWORK}
    restart: unless-stopped

  # 2. üß± Backend API - Development Service (Profile: 'dev')
  api-dev:
    profiles: ["dev"]
    container_name: ${PROJECT_NAME}_api_dev
    build:
      context: ./shared/backend
      dockerfile: Dockerfile
    # CRITICAL: Define DB connection URL using dev-specific variables
    environment:
      APP_ENV: ${APP_ENV_DEV}
      DB_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${DB_NAME_DEV}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
    ports:
      - "${DEV_BACKEND_PORT}:8000"
    volumes:
      # CRITICAL: Mounts local code for hot-reload
      - ./shared/backend:/app:cached
    depends_on:
      - db_main
    networks:
      - ${VALINOR_NETWORK}
    # Use uvicorn or similar dev server for hot reload
    command: ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  # 3. üöÄ Backend API - Production Service (Profile: 'prod')
  api-prod:
    profiles: ["prod"]
    container_name: ${PROJECT_NAME}_api_prod
    # Uses the same build context/Dockerfile as dev, but runs the stable CMD
    build:
      context: ./shared/backend
      dockerfile: Dockerfile
    environment:
      APP_ENV: ${APP_ENV_PROD}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${DB_NAME_PROD}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
    ports:
      - "${PROD_BACKEND_PORT}:8000"
    depends_on:
      - db_main
    networks:
      - ${VALINOR_NETWORK}
    # CMD is usually defined in the Dockerfile (e.g., Gunicorn)

  # 4. üåê Frontend - Development Service (Profile: 'dev')
  web-dev:
    profiles: ["dev"]
    container_name: ${PROJECT_NAME}_web_dev
    build:
      context: ./shared/frontend
      dockerfile: Dockerfile
    ports:
      - "${DEV_FRONTEND_PORT}:5173" # Vite's default dev port
    volumes:
      # Mounts local code for Vite hot-reload
      - ./shared/frontend:/app:cached
      - /app/node_modules # Prevents host node_modules from overriding container's
    depends_on:
      - api-dev # Wait for the API to be available
    networks:
      - ${VALINOR_NETWORK}
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173"]

  # 5. üöÄ Frontend - Production Service (Profile: 'prod')
  web-prod:
    profiles: ["prod"]
    container_name: ${PROJECT_NAME}_web_prod
    build:
      context: ./shared/frontend
      dockerfile: Dockerfile
    ports:
      - "${PROD_FRONTEND_PORT}:80" # Nginx default port
    depends_on:
      - api-prod
    networks:
      - ${VALINOR_NETWORK}
    # CMD is usually defined in the Dockerfile (e.g., Nginx)

# ------------------------------------------------------------
# VOLUMES & NETWORKS (External resources)
# ------------------------------------------------------------
volumes:
  postgres_data:

networks:
  ${VALINOR_NETWORK}:
    driver: bridge